<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prometheus AI Tutor â€” Rabdan Academy</title>
    <link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@300;400;500;600;700&family=Barlow:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --navy: #1A2F4F;
            --navy-dark: #0F1D2F;
            --navy-light: #2A4A6F;
            --gold: #C9A961;
            --gold-light: #E5D4A8;
            --gold-dark: #A68B4B;
            --white: #FFFFFF;
            --bg: #F7F8FA;
            --text: #2C3E50;
            --text-muted: #6B7C8F;
            --border: #E1E5EB;
            --success: #2E8B57;
            --warning: #E6A23C;
            --danger: #DC3545;
            --info: #17A2B8;
            --font-display: 'Barlow Condensed', 'Arial Nova Cond', sans-serif;
            --font-body: 'Barlow', -apple-system, sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-body);
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        .dashboard {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px 40px;
            min-height: 100vh;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 16px 0 24px;
            border-bottom: 2px solid var(--gold);
            margin-bottom: 24px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo {
            width: 65px;
            height: 65px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-icon {
            font-size: 40px;
        }

        .header-text h1 {
            font-family: var(--font-display);
            font-size: 28px;
            font-weight: 600;
            color: var(--navy);
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .header-subtitle {
            font-family: var(--font-display);
            font-size: 14px;
            color: var(--text-muted);
            font-weight: 400;
            margin-top: 4px;
            letter-spacing: 0.3px;
        }

        .header-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 10px;
        }

        .header-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .header-btn {
            padding: 10px 18px;
            background: var(--navy);
            color: var(--white);
            border: none;
            border-radius: 8px;
            font-family: var(--font-display);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 4px rgba(26, 47, 79, 0.2);
        }

        .header-btn:hover {
            background: var(--navy-light);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(26, 47, 79, 0.3);
        }

        .header-btn.gold {
            background: var(--gold);
            color: var(--navy);
            box-shadow: 0 2px 4px rgba(201, 169, 97, 0.3);
        }

        .header-btn.gold:hover {
            background: var(--gold-dark);
            box-shadow: 0 4px 8px rgba(201, 169, 97, 0.4);
        }

        .lang-toggle {
            display: flex;
            gap: 0;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .lang-btn {
            padding: 10px 20px;
            background: var(--white);
            color: var(--text-muted);
            border: 1px solid var(--border);
            font-family: var(--font-display);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.2s;
        }

        .lang-btn:first-child {
            border-radius: 8px 0 0 8px;
            border-right: none;
        }

        .lang-btn:last-child {
            border-radius: 0 8px 8px 0;
        }

        .lang-btn:hover:not(.active) {
            background: var(--bg);
            color: var(--navy);
        }

        .lang-btn.active {
            background: var(--navy);
            color: var(--white);
            border-color: var(--navy);
        }

        /* Module Selector Banner */
        .module-banner {
            background: var(--white);
            border: 1px solid var(--border);
            border-left: 4px solid var(--gold);
            border-radius: 0 8px 8px 0;
            padding: 16px 20px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .module-banner-icon {
            width: 44px;
            height: 44px;
            background: var(--navy);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 22px;
        }

        .module-banner-text {
            flex: 1;
        }

        .module-banner-title {
            font-family: var(--font-display);
            font-weight: 600;
            font-size: 15px;
            color: var(--navy);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .module-banner-subtitle {
            font-size: 13px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .module-selector {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .module-select {
            padding: 10px 16px;
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-family: var(--font-display);
            font-size: 13px;
            color: var(--navy);
            cursor: pointer;
            min-width: 220px;
        }

        .module-select:focus {
            outline: none;
            border-color: var(--gold);
        }

        .mode-badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-family: var(--font-display);
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .mode-badge.learn {
            background: rgba(46, 139, 87, 0.15);
            color: var(--success);
        }

        .mode-badge.learn:hover, .mode-badge.learn.active {
            background: var(--success);
            color: var(--white);
        }

        .mode-badge.quiz {
            background: rgba(23, 162, 184, 0.15);
            color: var(--info);
        }

        .mode-badge.quiz:hover, .mode-badge.quiz.active {
            background: var(--info);
            color: var(--white);
        }

        /* Main Layout */
        .main-content {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 24px;
        }

        /* Left Column */
        .left-column {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Avatar Card */
        .avatar-card {
            background: var(--white);
            border-radius: 12px;
            border: 1px solid var(--border);
            padding: 24px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .avatar-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gold);
        }

        .avatar-container {
            width: 180px;
            height: 180px;
            margin: 16px auto;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--navy) 0%, var(--navy-dark) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            border: 4px solid var(--gold);
            box-shadow: 
                0 4px 20px rgba(26, 47, 79, 0.3),
                0 0 0 4px var(--navy),
                0 0 0 8px rgba(201, 169, 97, 0.3);
        }

        .avatar-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center 15%;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .avatar-container:hover .avatar-image {
            transform: scale(1.02);
        }

        .avatar-speaking {
            animation: pulse 1s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .avatar-ring {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 2px solid var(--gold);
            opacity: 0;
        }

        .speaking .avatar-ring {
            animation: ring 1.5s ease-out infinite;
        }

        @keyframes ring {
            0% { transform: scale(1); opacity: 0.6; }
            100% { transform: scale(1.4); opacity: 0; }
        }

        .instructor-name {
            font-family: var(--font-display);
            font-size: 20px;
            font-weight: 600;
            color: var(--navy);
            margin-top: 16px;
        }

        .instructor-title {
            font-size: 13px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(46, 139, 87, 0.1);
            border-radius: 20px;
            font-size: 13px;
            color: var(--success);
            margin-top: 16px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: blink 2s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        /* Progress Card */
        .progress-card {
            background: var(--white);
            border-radius: 12px;
            border: 1px solid var(--border);
            padding: 20px;
        }

        .progress-card-title {
            font-family: var(--font-display);
            font-size: 14px;
            font-weight: 600;
            color: var(--navy);
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .progress-bar-container {
            margin-bottom: 16px;
        }

        .progress-bar-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .progress-bar-label {
            color: var(--text-muted);
        }

        .progress-bar-value {
            font-weight: 600;
            color: var(--gold-dark);
        }

        .progress-bar {
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--gold), var(--gold-light));
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .stat-item {
            background: var(--bg);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-family: var(--font-display);
            font-size: 24px;
            font-weight: 700;
            color: var(--navy);
        }

        .stat-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 2px;
        }

        /* Course Outline Card */
        .outline-card {
            background: var(--white);
            border-radius: 12px;
            border: 1px solid var(--border);
            padding: 20px;
        }

        .outline-card-title {
            font-family: var(--font-display);
            font-size: 14px;
            font-weight: 600;
            color: var(--navy);
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin-bottom: 16px;
        }

        .outline-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 4px;
        }

        .outline-item:hover {
            background: var(--bg);
        }

        .outline-item.active {
            background: rgba(201, 169, 97, 0.15);
            border-left: 3px solid var(--gold);
        }

        .outline-item.completed .outline-icon {
            background: var(--success);
            color: var(--white);
        }

        .outline-item.visited .outline-icon {
            background: var(--info);
            color: var(--white);
        }

        .outline-icon {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--bg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            flex-shrink: 0;
        }

        .outline-text {
            flex: 1;
            font-size: 13px;
            color: var(--text);
        }

        .outline-ask-btn {
            padding: 4px 8px;
            background: var(--gold);
            color: var(--navy);
            border: none;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            opacity: 0;
            transition: all 0.2s;
        }

        .outline-item:hover .outline-ask-btn {
            opacity: 1;
        }

        /* Chat Area */
        .chat-area {
            background: var(--white);
            border-radius: 12px;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            height: calc(100vh - 220px);
            min-height: 500px;
        }

        .chat-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-title {
            font-family: var(--font-display);
            font-size: 16px;
            font-weight: 600;
            color: var(--navy);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .chat-actions {
            display: flex;
            gap: 8px;
        }

        .chat-action-btn {
            padding: 6px 12px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 12px;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .chat-action-btn:hover {
            border-color: var(--gold);
            color: var(--navy);
        }

        /* Topic Detection Label */
        .topic-label {
            display: inline-block;
            padding: 4px 10px;
            background: rgba(23, 162, 184, 0.1);
            border-radius: 12px;
            font-size: 10px;
            color: var(--info);
            margin-top: 8px;
            font-weight: 500;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .message {
            display: flex;
            gap: 12px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--bg);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 16px;
        }

        .message.assistant .message-avatar {
            background: var(--navy);
            color: var(--gold);
        }

        .message-content {
            max-width: 70%;
            background: var(--bg);
            border-radius: 12px;
            padding: 14px 18px;
        }

        .message.user .message-content {
            background: var(--navy);
            color: var(--white);
        }

        .message-text {
            font-size: 14px;
            line-height: 1.6;
        }

        .message-text strong {
            color: var(--gold-dark);
        }

        .message.user .message-text strong {
            color: var(--gold-light);
        }

        .message-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border);
        }

        .msg-action-btn {
            padding: 4px 10px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-muted);
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .msg-action-btn:hover {
            border-color: var(--gold);
            color: var(--gold-dark);
        }

        .msg-action-btn.liked {
            background: rgba(46, 139, 87, 0.15);
            border-color: var(--success);
            color: var(--success);
        }

        .msg-action-btn.bookmarked {
            background: rgba(201, 169, 97, 0.15);
            border-color: var(--gold);
            color: var(--gold-dark);
        }

        /* Guided Learning Follow-ups */
        .follow-ups {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .follow-up-btn {
            padding: 6px 14px;
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 16px;
            font-size: 12px;
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s;
        }

        .follow-up-btn:hover {
            border-color: var(--gold);
            background: rgba(201, 169, 97, 0.1);
        }

        .follow-up-btn.guided {
            border-color: var(--info);
            background: rgba(23, 162, 184, 0.1);
            color: var(--info);
        }

        .follow-up-btn.guided:hover {
            background: var(--info);
            color: var(--white);
        }

        /* Level Indicator */
        .level-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 8px;
            font-size: 11px;
            color: var(--text-muted);
        }

        .level-badge {
            padding: 2px 8px;
            background: var(--gold);
            color: var(--navy);
            border-radius: 10px;
            font-weight: 600;
        }

        /* Quiz Container */
        .quiz-container {
            background: var(--white);
            border: 2px solid var(--gold);
            border-radius: 12px;
            padding: 20px;
            margin: 10px 0;
        }

        .quiz-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .quiz-title {
            font-family: var(--font-display);
            font-size: 14px;
            font-weight: 600;
            color: var(--info);
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        .quiz-progress {
            font-size: 13px;
            color: var(--text-muted);
        }

        .quiz-question {
            font-size: 15px;
            color: var(--navy);
            margin-bottom: 16px;
            line-height: 1.5;
        }

        .quiz-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .quiz-option {
            padding: 14px 18px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
            font-family: var(--font-body);
            font-size: 14px;
            color: var(--text);
        }

        .quiz-option:hover {
            border-color: var(--gold);
            background: rgba(201, 169, 97, 0.1);
        }

        .quiz-option.correct {
            border-color: var(--success);
            background: rgba(46, 139, 87, 0.15);
        }

        .quiz-option.incorrect {
            border-color: var(--danger);
            background: rgba(220, 53, 69, 0.1);
        }

        .quiz-feedback {
            margin-top: 16px;
            padding: 14px;
            border-radius: 8px;
            font-size: 13px;
        }

        .quiz-feedback.correct {
            background: rgba(46, 139, 87, 0.15);
            border: 1px solid var(--success);
            color: var(--success);
        }

        .quiz-feedback.incorrect {
            background: rgba(220, 53, 69, 0.1);
            border: 1px solid var(--danger);
            color: var(--danger);
        }

        .quiz-next-btn {
            margin-top: 16px;
            padding: 12px 24px;
            background: var(--gold);
            border: none;
            border-radius: 8px;
            color: var(--navy);
            font-family: var(--font-display);
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quiz-next-btn:hover {
            background: var(--gold-dark);
        }

        /* Quick Topics */
        .quick-topics {
            padding: 16px 20px;
            border-top: 1px solid var(--border);
            background: var(--bg);
        }

        .topics-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin-bottom: 10px;
        }

        .topics-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .topic-chip {
            padding: 8px 16px;
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 13px;
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s;
        }

        .topic-chip:hover {
            border-color: var(--gold);
            background: rgba(201, 169, 97, 0.1);
            color: var(--navy);
        }

        /* Input Area */
        .chat-input-area {
            padding: 16px 20px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .input-wrapper {
            flex: 1;
            position: relative;
        }

        .chat-input {
            width: 100%;
            padding: 14px 50px 14px 18px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 25px;
            font-family: var(--font-body);
            font-size: 14px;
            color: var(--text);
            resize: none;
            transition: all 0.2s;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--gold);
            box-shadow: 0 0 0 3px rgba(201, 169, 97, 0.2);
        }

        .chat-input::placeholder {
            color: var(--text-muted);
        }

        .input-actions {
            position: absolute;
            right: 10px;
            bottom: 10px;
            display: flex;
            gap: 4px;
        }

        .input-action-btn {
            width: 32px;
            height: 32px;
            background: transparent;
            border: none;
            border-radius: 50%;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s;
        }

        .input-action-btn:hover {
            background: var(--white);
            color: var(--navy);
        }

        .input-action-btn.recording {
            background: var(--danger);
            color: var(--white);
            animation: pulse 1s infinite;
        }

        .send-btn {
            width: 48px;
            height: 48px;
            background: var(--navy);
            border: none;
            border-radius: 50%;
            color: var(--gold);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .send-btn:hover {
            background: var(--gold);
            color: var(--navy);
            transform: scale(1.05);
        }

        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 12px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--text-muted);
            border-radius: 50%;
            animation: typingBounce 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typingBounce {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        /* Side Panel */
        .side-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: var(--white);
            border-left: 1px solid var(--border);
            z-index: 1000;
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .side-panel.open {
            right: 0;
        }

        .panel-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-title {
            font-family: var(--font-display);
            font-size: 16px;
            font-weight: 600;
            color: var(--navy);
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        .panel-close {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--text-muted);
            cursor: pointer;
        }

        .panel-close:hover {
            color: var(--navy);
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        /* Overlay */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .overlay.show {
            opacity: 1;
            visibility: visible;
        }

        /* History Items */
        .history-item {
            padding: 14px;
            background: var(--bg);
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .history-item:hover {
            background: rgba(201, 169, 97, 0.15);
        }

        .history-question {
            font-size: 13px;
            color: var(--text);
            margin-bottom: 6px;
        }

        .history-meta {
            font-size: 11px;
            color: var(--text-muted);
        }

        /* Settings */
        .settings-section {
            margin-bottom: 24px;
        }

        .settings-label {
            font-family: var(--font-display);
            font-size: 12px;
            font-weight: 600;
            color: var(--navy);
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin-bottom: 12px;
        }

        .api-input {
            width: 100%;
            padding: 12px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-family: var(--font-body);
            font-size: 14px;
            margin-bottom: 12px;
        }

        .api-input:focus {
            outline: none;
            border-color: var(--gold);
        }

        .save-btn {
            width: 100%;
            padding: 12px;
            background: var(--gold);
            border: none;
            border-radius: 6px;
            color: var(--navy);
            font-family: var(--font-display);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        .save-btn:hover {
            background: var(--gold-dark);
        }

        /* Toast */
        .toast-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .toast {
            padding: 12px 20px;
            background: var(--navy);
            color: var(--white);
            border-radius: 8px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
            animation: toastIn 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .toast.success { border-left: 4px solid var(--success); }
        .toast.error { border-left: 4px solid var(--danger); }

        @keyframes toastIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* RTL Support */
        [dir="rtl"] .message.user {
            flex-direction: row;
        }

        [dir="rtl"] .message:not(.user) {
            flex-direction: row-reverse;
        }

        [dir="rtl"] .outline-item.active {
            border-left: none;
            border-right: 3px solid var(--gold);
        }

        [dir="rtl"] .module-banner {
            border-left: none;
            border-right: 4px solid var(--gold);
            border-radius: 8px 0 0 8px;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            .left-column {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .dashboard {
                padding: 16px;
            }
            .header {
                flex-direction: column;
                gap: 16px;
            }
            .header-right {
                align-items: flex-start;
            }
            .module-banner {
                flex-direction: column;
                text-align: center;
            }
            .module-selector {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <div class="logo">
                    <span class="logo-icon">ğŸ”¥</span>
                </div>
                <div class="header-text">
                    <h1>Prometheus AI Tutor</h1>
                    <div class="header-subtitle">Rabdan Academy â€” Intelligent Training System</div>
                </div>
            </div>
            <div class="header-right">
                <div class="header-buttons">
                    <div class="lang-toggle">
                        <button class="lang-btn active" id="lang-en" onclick="setLanguage('en')">EN</button>
                        <button class="lang-btn" id="lang-ar" onclick="setLanguage('ar')">Ø¹Ø±Ø¨ÙŠ</button>
                    </div>
                    <button class="header-btn" onclick="resetDemo()">â†» Reset Demo</button>
                    <button class="header-btn gold" onclick="togglePanel('settings')">ğŸ”’ API Settings</button>
                </div>
            </div>
        </header>

        <!-- Module Banner -->
        <div class="module-banner">
            <div class="module-banner-icon">ğŸ›¡ï¸</div>
            <div class="module-banner-text">
                <div class="module-banner-title" id="module-title">Cybersecurity Response Training</div>
                <div class="module-banner-subtitle" id="module-subtitle">Federal Law 35/2023 â€” UAE Cybercrime Legislation</div>
            </div>
            <div class="module-selector">
                <select class="module-select" id="module-select" onchange="changeModule()">
                    <option value="cybersecurity">ğŸ›¡ï¸ Cybersecurity Response</option>
                    <option value="crisis">ğŸš¨ Crisis Management</option>
                    <option value="emergency">ğŸš‘ Emergency Procedures</option>
                    <option value="leadership">ğŸ‘” Leadership & Command</option>
                </select>
                <button class="mode-badge learn active" id="learn-mode-btn" onclick="setMode('learn')">ğŸ“š Learn</button>
                <button class="mode-badge quiz" id="quiz-mode-btn" onclick="setMode('quiz')">â“ Quiz</button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Left Column -->
            <div class="left-column">
                <!-- Avatar Card -->
                <div class="avatar-card">
                    <div class="avatar-container" id="avatar-container">
                        <div class="avatar-ring"></div>
                        <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI1MCIgZmlsbD0iIzFBMkY0RiIvPjxjaXJjbGUgY3g9IjUwIiBjeT0iMzgiIHI9IjE4IiBmaWxsPSIjRTVENEE4Ii8+PHBhdGggZD0iTTI1IDg1YzAtMjAgMTEtMzIgMjUtMzJzMjUgMTIgMjUgMzIiIGZpbGw9IiNDOUE5NjEiLz48L3N2Zz4=" 
                             class="avatar-image" id="avatar" alt="AI Tutor">
                    </div>
                    <div class="instructor-name">Matthew Dodds</div>
                    <div class="instructor-title">Training Instructor</div>
                    <div class="status-indicator">
                        <span class="status-dot"></span>
                        <span id="status-text">Online & Ready</span>
                    </div>
                </div>

                <!-- Progress Card -->
                <div class="progress-card">
                    <div class="progress-card-title" id="progress-title">ğŸ“Š Your Progress</div>
                    <div class="progress-bar-container">
                        <div class="progress-bar-header">
                            <span class="progress-bar-label" id="progress-label">Module Completion</span>
                            <span class="progress-bar-value" id="progress-percent">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="stat-questions">0</div>
                            <div class="stat-label" id="label-questions">Questions</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="stat-quiz">0%</div>
                            <div class="stat-label" id="label-quiz">Quiz Score</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="stat-chapters">0/0</div>
                            <div class="stat-label" id="label-chapters">Chapters</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="stat-level">1</div>
                            <div class="stat-label" id="label-level">Level</div>
                        </div>
                    </div>
                </div>

                <!-- Course Outline Card -->
                <div class="outline-card">
                    <div class="outline-card-title" id="outline-title">ğŸ“‹ Course Outline</div>
                    <div id="course-outline">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- Chat Area -->
            <div class="chat-area">
                <div class="chat-header">
                    <div class="chat-title" id="chat-title">ğŸ’¬ Learning Conversation</div>
                    <div class="chat-actions">
                        <button class="chat-action-btn" onclick="clearChat()">ğŸ—‘ï¸ Clear</button>
                        <button class="chat-action-btn" id="speaker-btn" onclick="toggleSpeaker()">ğŸ”Š Voice On</button>
                    </div>
                </div>

                <div class="chat-messages" id="messages-area">
                    <!-- Messages will be added here -->
                </div>

                <!-- Quick Topics -->
                <div class="quick-topics">
                    <div class="topics-label" id="topics-label">Quick Topics</div>
                    <div class="topics-grid" id="topics-grid">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Input Area -->
                <div class="chat-input-area">
                    <div class="input-wrapper">
                        <textarea class="chat-input" id="message-input" 
                            placeholder="Ask me anything about the training module..." 
                            rows="1" onkeydown="handleKeyDown(event)"></textarea>
                        <div class="input-actions">
                            <button class="input-action-btn" id="voice-btn" onclick="toggleVoiceInput()">ğŸ¤</button>
                        </div>
                    </div>
                    <button class="send-btn" onclick="sendMessage()">â¤</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Overlay -->
    <div class="overlay" id="overlay" onclick="closeAllPanels()"></div>

    <!-- History Panel -->
    <div class="side-panel" id="history-panel">
        <div class="panel-header">
            <span class="panel-title">ğŸ“œ Session History</span>
            <button class="panel-close" onclick="togglePanel('history')">âœ•</button>
        </div>
        <div class="panel-content" id="history-content">
            <p style="color: var(--text-muted); text-align: center;">Your conversation history will appear here</p>
        </div>
    </div>

    <!-- Settings Panel -->
    <div class="side-panel" id="settings-panel">
        <div class="panel-header">
            <span class="panel-title">âš™ï¸ Settings</span>
            <button class="panel-close" onclick="togglePanel('settings')">âœ•</button>
        </div>
        <div class="panel-content">
            <div class="settings-section">
                <div class="settings-label">API Configuration</div>
                <input type="password" class="api-input" id="api-key-input" placeholder="Enter Claude API Key">
                <button class="save-btn" onclick="saveApiKey()">Save API Key</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <script>
        // ============================================
        // STATE MANAGEMENT
        // ============================================
        const state = {
            currentLang: 'en',
            currentModule: 'cybersecurity',
            currentMode: 'learn',
            currentChapter: null,
            apiKey: '',
            speakerEnabled: true,
            isRecording: false,
            messages: [],
            history: [],
            visitedChapters: JSON.parse(localStorage.getItem('prometheus_visited') || '{}'),
            stats: {
                questions: 0,
                quizCorrect: 0,
                quizTotal: 0,
                level: 1
            },
            currentQuiz: null,
            lastDetectedTopic: null
        };

        // ============================================
        // MODULE DATA (Option A)
        // ============================================
        const MODULES = {
            cybersecurity: {
                id: 'cybersecurity',
                title: { en: 'Cybersecurity Response Training', ar: 'Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù„Ù„Ø£Ù…Ù† Ø§Ù„Ø³ÙŠØ¨Ø±Ø§Ù†ÙŠ' },
                subtitle: { en: 'Federal Law 35/2023 â€” UAE Cybercrime Legislation', ar: 'Ø§Ù„Ù‚Ø§Ù†ÙˆÙ† Ø§Ù„Ø§ØªØ­Ø§Ø¯ÙŠ 35/2023 â€” ØªØ´Ø±ÙŠØ¹Ø§Øª Ø§Ù„Ø¬Ø±Ø§Ø¦Ù… Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©' },
                icon: 'ğŸ›¡ï¸',
                outline: [
                    { id: 'intro', title: { en: 'Introduction to Cyber Law', ar: 'Ù…Ù‚Ø¯Ù…Ø© ÙÙŠ Ø§Ù„Ù‚Ø§Ù†ÙˆÙ† Ø§Ù„Ø³ÙŠØ¨Ø±Ø§Ù†ÙŠ' }, icon: 'ğŸ“œ' },
                    { id: 'threats', title: { en: 'Types of Cyber Threats', ar: 'Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„ØªÙ‡Ø¯ÙŠØ¯Ø§Øª Ø§Ù„Ø³ÙŠØ¨Ø±Ø§Ù†ÙŠØ©' }, icon: 'âš ï¸' },
                    { id: 'reporting', title: { en: 'Incident Reporting', ar: 'Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ø§Ù„Ø­ÙˆØ§Ø¯Ø«' }, icon: 'ğŸ“' },
                    { id: 'penalties', title: { en: 'Penalties & Enforcement', ar: 'Ø§Ù„Ø¹Ù‚ÙˆØ¨Ø§Øª ÙˆØ§Ù„ØªÙ†ÙÙŠØ°' }, icon: 'âš–ï¸' },
                    { id: 'prevention', title: { en: 'Prevention Strategies', ar: 'Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª Ø§Ù„ÙˆÙ‚Ø§ÙŠØ©' }, icon: 'ğŸ›¡ï¸' },
                    { id: 'response', title: { en: 'Emergency Response', ar: 'Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù„Ù„Ø·ÙˆØ§Ø±Ø¦' }, icon: 'ğŸš¨' }
                ],
                topics: {
                    en: ['What is Federal Law 35/2023?', 'How do I report a cyber attack?', 'What are the penalties?', 'Explain phishing attacks', 'Data protection requirements'],
                    ar: ['Ù…Ø§ Ù‡Ùˆ Ø§Ù„Ù‚Ø§Ù†ÙˆÙ† Ø§Ù„Ø§ØªØ­Ø§Ø¯ÙŠ 35/2023ØŸ', 'ÙƒÙŠÙ Ø£Ø¨Ù„Øº Ø¹Ù† Ù‡Ø¬ÙˆÙ… Ø³ÙŠØ¨Ø±Ø§Ù†ÙŠØŸ', 'Ù…Ø§ Ù‡ÙŠ Ø§Ù„Ø¹Ù‚ÙˆØ¨Ø§ØªØŸ']
                },
                keywords: ['cyber', 'hack', 'phishing', 'malware', 'ransomware', 'virus', 'breach', 'password', 'encryption', 'firewall', 'law 35', 'cybercrime', 'data theft', 'unauthorized access'],
                quizQuestions: [
                    { 
                        question: { en: 'What is the primary purpose of Federal Law 35/2023?', ar: 'Ù…Ø§ Ù‡Ùˆ Ø§Ù„ØºØ±Ø¶ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù…Ù† Ø§Ù„Ù‚Ø§Ù†ÙˆÙ† Ø§Ù„Ø§ØªØ­Ø§Ø¯ÙŠ 35/2023ØŸ' },
                        options: { en: ['To regulate social media', 'To combat cybercrimes and protect digital infrastructure', 'To establish ISPs', 'To promote e-commerce'], ar: ['ØªÙ†Ø¸ÙŠÙ… ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ', 'Ù…ÙƒØ§ÙØ­Ø© Ø§Ù„Ø¬Ø±Ø§Ø¦Ù… Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ© ÙˆØ­Ù…Ø§ÙŠØ© Ø§Ù„Ø¨Ù†ÙŠØ© Ø§Ù„ØªØ­ØªÙŠØ© Ø§Ù„Ø±Ù‚Ù…ÙŠØ©', 'Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø²ÙˆØ¯ÙŠ Ø®Ø¯Ù…Ø© Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª', 'ØªØ¹Ø²ÙŠØ² Ø§Ù„ØªØ¬Ø§Ø±Ø© Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©'] },
                        correct: 1,
                        explanation: { en: 'Federal Law 35/2023 was enacted to combat cybercrimes and protect UAE digital infrastructure.', ar: 'ØªÙ… Ø³Ù† Ø§Ù„Ù‚Ø§Ù†ÙˆÙ† Ø§Ù„Ø§ØªØ­Ø§Ø¯ÙŠ 35/2023 Ù„Ù…ÙƒØ§ÙØ­Ø© Ø§Ù„Ø¬Ø±Ø§Ø¦Ù… Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ© ÙˆØ­Ù…Ø§ÙŠØ© Ø§Ù„Ø¨Ù†ÙŠØ© Ø§Ù„ØªØ­ØªÙŠØ© Ø§Ù„Ø±Ù‚Ù…ÙŠØ© Ù„Ù„Ø¥Ù…Ø§Ø±Ø§Øª.' }
                    },
                    { 
                        question: { en: 'What is the first step when responding to a cyber attack?', ar: 'Ù…Ø§ Ù‡ÙŠ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø£ÙˆÙ„Ù‰ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù„Ù‡Ø¬ÙˆÙ… Ø³ÙŠØ¨Ø±Ø§Ù†ÙŠØŸ' },
                        options: { en: ['Delete evidence', 'Continue working', 'Isolate affected systems', 'Wait 24 hours'], ar: ['Ø­Ø°Ù Ø§Ù„Ø£Ø¯Ù„Ø©', 'Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø± ÙÙŠ Ø§Ù„Ø¹Ù…Ù„', 'Ø¹Ø²Ù„ Ø§Ù„Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ù…ØªØ£Ø«Ø±Ø©', 'Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± 24 Ø³Ø§Ø¹Ø©'] },
                        correct: 2,
                        explanation: { en: 'Immediate isolation prevents the attack from spreading.', ar: 'Ø§Ù„Ø¹Ø²Ù„ Ø§Ù„ÙÙˆØ±ÙŠ ÙŠÙ…Ù†Ø¹ Ø§Ù†ØªØ´Ø§Ø± Ø§Ù„Ù‡Ø¬ÙˆÙ….' }
                    },
                    { 
                        question: { en: 'What is the maximum fine for critical infrastructure attacks?', ar: 'Ù…Ø§ Ù‡ÙŠ Ø§Ù„ØºØ±Ø§Ù…Ø© Ø§Ù„Ù‚ØµÙˆÙ‰ Ù„Ù‡Ø¬Ù…Ø§Øª Ø§Ù„Ø¨Ù†ÙŠØ© Ø§Ù„ØªØ­ØªÙŠØ© Ø§Ù„Ø­ÙŠÙˆÙŠØ©ØŸ' },
                        options: { en: ['50,000 AED', '500,000 AED', '1,000,000 AED', '2,000,000 AED'], ar: ['50,000 Ø¯Ø±Ù‡Ù…', '500,000 Ø¯Ø±Ù‡Ù…', '1,000,000 Ø¯Ø±Ù‡Ù…', '2,000,000 Ø¯Ø±Ù‡Ù…'] },
                        correct: 3,
                        explanation: { en: 'Critical infrastructure attacks carry penalties up to 2,000,000 AED.', ar: 'ØªØ­Ù…Ù„ Ù‡Ø¬Ù…Ø§Øª Ø§Ù„Ø¨Ù†ÙŠØ© Ø§Ù„ØªØ­ØªÙŠØ© Ø§Ù„Ø­ÙŠÙˆÙŠØ© Ø¹Ù‚ÙˆØ¨Ø§Øª ØªØµÙ„ Ø¥Ù„Ù‰ 2,000,000 Ø¯Ø±Ù‡Ù….' }
                    }
                ],
                responses: {
                    en: {
                        'What is Federal Law 35/2023?': "Federal Law 35/2023 is the UAE's comprehensive cybercrime legislation enacted to combat cybercrimes and protect digital infrastructure.\n\n**Key Coverage:**\nâ€¢ Unauthorized access to systems\nâ€¢ Data theft and privacy violations\nâ€¢ Online fraud and financial crimes\nâ€¢ Identity theft and impersonation\n\n**Penalties:** Range from 50,000 to 2,000,000 AED and imprisonment from 3 months to life.",
                        'How do I report a cyber attack?': "**5 Essential Steps for Reporting a Cyber Attack:**\n\n1ï¸âƒ£ **Isolate** â€” Disconnect affected systems immediately\n2ï¸âƒ£ **Document** â€” Record timestamps, screenshots, all evidence\n3ï¸âƒ£ **Report Internally** â€” Notify supervisor and IT security\n4ï¸âƒ£ **File Official Report** â€” Contact UAE CERT\n5ï¸âƒ£ **Cooperate** â€” Work with investigators, preserve evidence\n\nâš¡ Speed is critical â€” report immediately!",
                        'What are the penalties?': "**Penalties Under Federal Law 35/2023:**\n\nâ€¢ **Minor offenses** (unauthorized access): 50,000 - 200,000 AED fine\nâ€¢ **Data theft**: 100,000 - 500,000 AED + up to 2 years imprisonment\nâ€¢ **Critical infrastructure**: Up to 2,000,000 AED + 5-15 years\nâ€¢ **State security threats**: Up to 3,000,000 AED + life possible\n\nAdditional: Deportation for non-citizens, equipment confiscation."
                    },
                    ar: {
                        'Ù…Ø§ Ù‡Ùˆ Ø§Ù„Ù‚Ø§Ù†ÙˆÙ† Ø§Ù„Ø§ØªØ­Ø§Ø¯ÙŠ 35/2023ØŸ': "Ø§Ù„Ù‚Ø§Ù†ÙˆÙ† Ø§Ù„Ø§ØªØ­Ø§Ø¯ÙŠ Ø±Ù‚Ù… 35 Ù„Ø³Ù†Ø© 2023 Ù‡Ùˆ Ø§Ù„ØªØ´Ø±ÙŠØ¹ Ø§Ù„Ø´Ø§Ù…Ù„ Ù„Ù„Ø¥Ù…Ø§Ø±Ø§Øª Ù„Ù…ÙƒØ§ÙØ­Ø© Ø§Ù„Ø¬Ø±Ø§Ø¦Ù… Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©.\n\n**ÙŠØºØ·ÙŠ:**\nâ€¢ Ø§Ù„ÙˆØµÙˆÙ„ ØºÙŠØ± Ø§Ù„Ù…ØµØ±Ø­ Ø¨Ù‡ Ù„Ù„Ø£Ù†Ø¸Ù…Ø©\nâ€¢ Ø³Ø±Ù‚Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù†ØªÙ‡Ø§Ùƒ Ø§Ù„Ø®ØµÙˆØµÙŠØ©\nâ€¢ Ø§Ù„Ø§Ø­ØªÙŠØ§Ù„ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆØ§Ù„Ø¬Ø±Ø§Ø¦Ù… Ø§Ù„Ù…Ø§Ù„ÙŠØ©\nâ€¢ Ø³Ø±Ù‚Ø© Ø§Ù„Ù‡ÙˆÙŠØ© ÙˆØ§Ù†ØªØ­Ø§Ù„ Ø§Ù„Ø´Ø®ØµÙŠØ©\n\n**Ø§Ù„Ø¹Ù‚ÙˆØ¨Ø§Øª:** Ù…Ù† 50,000 Ø¥Ù„Ù‰ 2,000,000 Ø¯Ø±Ù‡Ù… ÙˆØ§Ù„Ø³Ø¬Ù† Ù…Ù† 3 Ø£Ø´Ù‡Ø± Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø¤Ø¨Ø¯.",
                        'ÙƒÙŠÙ Ø£Ø¨Ù„Øº Ø¹Ù† Ù‡Ø¬ÙˆÙ… Ø³ÙŠØ¨Ø±Ø§Ù†ÙŠØŸ': "**5 Ø®Ø·ÙˆØ§Øª Ø£Ø³Ø§Ø³ÙŠØ© Ù„Ù„Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ù‡Ø¬ÙˆÙ… Ø³ÙŠØ¨Ø±Ø§Ù†ÙŠ:**\n\n1ï¸âƒ£ **Ø§Ù„Ø¹Ø²Ù„** â€” Ø§ÙØµÙ„ Ø§Ù„Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ù…ØªØ£Ø«Ø±Ø© ÙÙˆØ±Ø§Ù‹\n2ï¸âƒ£ **Ø§Ù„ØªÙˆØ«ÙŠÙ‚** â€” Ø³Ø¬Ù„ Ø§Ù„Ø£ÙˆÙ‚Ø§Øª ÙˆÙ„Ù‚Ø·Ø§Øª Ø§Ù„Ø´Ø§Ø´Ø© ÙˆØ§Ù„Ø£Ø¯Ù„Ø©\n3ï¸âƒ£ **Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ** â€” Ø£Ø®Ø¨Ø± Ø§Ù„Ù…Ø´Ø±Ù ÙˆØ£Ù…Ù† ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª\n4ï¸âƒ£ **ØªÙ‚Ø¯ÙŠÙ… Ø¨Ù„Ø§Øº Ø±Ø³Ù…ÙŠ** â€” ØªÙˆØ§ØµÙ„ Ù…Ø¹ ÙØ±ÙŠÙ‚ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù„Ø·ÙˆØ§Ø±Ø¦ Ø§Ù„Ø­Ø§Ø³Ø¨ Ø§Ù„Ø¢Ù„ÙŠ\n5ï¸âƒ£ **Ø§Ù„ØªØ¹Ø§ÙˆÙ†** â€” Ø§Ø¹Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù…Ø­Ù‚Ù‚ÙŠÙ† ÙˆØ§Ø­ÙØ¸ Ø§Ù„Ø£Ø¯Ù„Ø©\n\nâš¡ Ø§Ù„Ø³Ø±Ø¹Ø© Ø­Ø§Ø³Ù…Ø© â€” Ø£Ø¨Ù„Øº ÙÙˆØ±Ø§Ù‹!",
                        'Ù…Ø§ Ù‡ÙŠ Ø§Ù„Ø¹Ù‚ÙˆØ¨Ø§ØªØŸ': "**Ø§Ù„Ø¹Ù‚ÙˆØ¨Ø§Øª Ø¨Ù…ÙˆØ¬Ø¨ Ø§Ù„Ù‚Ø§Ù†ÙˆÙ† Ø§Ù„Ø§ØªØ­Ø§Ø¯ÙŠ 35/2023:**\n\nâ€¢ **Ø§Ù„Ø¬Ø±Ø§Ø¦Ù… Ø§Ù„Ø¨Ø³ÙŠØ·Ø©**: ØºØ±Ø§Ù…Ø© 50,000 - 200,000 Ø¯Ø±Ù‡Ù…\nâ€¢ **Ø³Ø±Ù‚Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª**: 100,000 - 500,000 Ø¯Ø±Ù‡Ù… + Ø§Ù„Ø³Ø¬Ù† Ø­ØªÙ‰ Ø³Ù†ØªÙŠÙ†\nâ€¢ **Ø§Ù„Ø¨Ù†ÙŠØ© Ø§Ù„ØªØ­ØªÙŠØ© Ø§Ù„Ø­ÙŠÙˆÙŠØ©**: Ø­ØªÙ‰ 2,000,000 Ø¯Ø±Ù‡Ù… + 5-15 Ø³Ù†Ø©\nâ€¢ **ØªÙ‡Ø¯ÙŠØ¯Ø§Øª Ø£Ù…Ù† Ø§Ù„Ø¯ÙˆÙ„Ø©**: Ø­ØªÙ‰ 3,000,000 Ø¯Ø±Ù‡Ù… + Ø§Ù„Ù…Ø¤Ø¨Ø¯ Ù…Ø­ØªÙ…Ù„\n\nØ¥Ø¶Ø§ÙÙŠ: ØªØ±Ø­ÙŠÙ„ ØºÙŠØ± Ø§Ù„Ù…ÙˆØ§Ø·Ù†ÙŠÙ†ØŒ Ù…ØµØ§Ø¯Ø±Ø© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª."
                    }
                }
            },
            crisis: {
                id: 'crisis',
                title: { en: 'Crisis Management', ar: 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø²Ù…Ø§Øª' },
                subtitle: { en: 'Strategic Response Framework', ar: 'Ø¥Ø·Ø§Ø± Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©' },
                icon: 'ğŸš¨',
                outline: [
                    { id: 'fundamentals', title: { en: 'Crisis Fundamentals', ar: 'Ø£Ø³Ø§Ø³ÙŠØ§Øª Ø§Ù„Ø£Ø²Ù…Ø§Øª' }, icon: 'ğŸ“Š' },
                    { id: 'assessment', title: { en: 'Threat Assessment', ar: 'ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ØªÙ‡Ø¯ÙŠØ¯Ø§Øª' }, icon: 'ğŸ”' },
                    { id: 'communication', title: { en: 'Crisis Communication', ar: 'Ø§Ù„ØªÙˆØ§ØµÙ„ ÙÙŠ Ø§Ù„Ø£Ø²Ù…Ø§Øª' }, icon: 'ğŸ“¢' },
                    { id: 'coordination', title: { en: 'Team Coordination', ar: 'ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙØ±ÙŠÙ‚' }, icon: 'ğŸ‘¥' },
                    { id: 'recovery', title: { en: 'Recovery Planning', ar: 'ØªØ®Ø·ÙŠØ· Ø§Ù„ØªØ¹Ø§ÙÙŠ' }, icon: 'ğŸ”„' }
                ],
                topics: {
                    en: ['What defines a crisis?', 'Crisis communication best practices', 'Building a response team', 'Media management', 'Post-crisis evaluation'],
                    ar: ['Ù…Ø§ Ø§Ù„Ø°ÙŠ ÙŠØ¹Ø±Ù‘Ù Ø§Ù„Ø£Ø²Ù…Ø©ØŸ', 'Ø£ÙØ¶Ù„ Ù…Ù…Ø§Ø±Ø³Ø§Øª Ø§Ù„ØªÙˆØ§ØµÙ„ ÙÙŠ Ø§Ù„Ø£Ø²Ù…Ø§Øª']
                },
                keywords: ['crisis', 'emergency', 'disaster', 'incident', 'response', 'media', 'communication', 'stakeholder', 'recovery', 'assessment'],
                quizQuestions: [
                    { 
                        question: { en: 'What is the golden hour in crisis management?', ar: 'Ù…Ø§ Ù‡ÙŠ Ø§Ù„Ø³Ø§Ø¹Ø© Ø§Ù„Ø°Ù‡Ø¨ÙŠØ© ÙÙŠ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø²Ù…Ø§ØªØŸ' },
                        options: { en: ['First hour after crisis begins', 'Lunch break', 'Hour before media arrives', 'Any normal hour'], ar: ['Ø§Ù„Ø³Ø§Ø¹Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ Ø¨Ø¹Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„Ø£Ø²Ù…Ø©', 'Ø§Ø³ØªØ±Ø§Ø­Ø© Ø§Ù„ØºØ¯Ø§Ø¡', 'Ø³Ø§Ø¹Ø© Ù‚Ø¨Ù„ ÙˆØµÙˆÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù…', 'Ø£ÙŠ Ø³Ø§Ø¹Ø© Ø¹Ø§Ø¯ÙŠØ©'] },
                        correct: 0,
                        explanation: { en: 'The golden hour is the critical first hour when immediate response is most crucial.', ar: 'Ø§Ù„Ø³Ø§Ø¹Ø© Ø§Ù„Ø°Ù‡Ø¨ÙŠØ© Ù‡ÙŠ Ø§Ù„Ø³Ø§Ø¹Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ Ø§Ù„Ø­Ø±Ø¬Ø© Ø¹Ù†Ø¯Ù…Ø§ ØªÙƒÙˆÙ† Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„ÙÙˆØ±ÙŠØ© Ø£ÙƒØ«Ø± Ø£Ù‡Ù…ÙŠØ©.' }
                    }
                ],
                responses: { en: {}, ar: {} }
            },
            emergency: {
                id: 'emergency',
                title: { en: 'Emergency Procedures', ar: 'Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø·ÙˆØ§Ø±Ø¦' },
                subtitle: { en: 'Standard Operating Protocols', ar: 'Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„Ø§Øª Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠØ©' },
                icon: 'ğŸš‘',
                outline: [
                    { id: 'protocols', title: { en: 'Emergency Protocols', ar: 'Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„Ø§Øª Ø§Ù„Ø·ÙˆØ§Ø±Ø¦' }, icon: 'ğŸ“‹' },
                    { id: 'evacuation', title: { en: 'Evacuation Procedures', ar: 'Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø¥Ø®Ù„Ø§Ø¡' }, icon: 'ğŸšª' },
                    { id: 'firstaid', title: { en: 'First Aid Basics', ar: 'Ø£Ø³Ø§Ø³ÙŠØ§Øª Ø§Ù„Ø¥Ø³Ø¹Ø§ÙØ§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ©' }, icon: 'ğŸ¥' },
                    { id: 'fire', title: { en: 'Fire Safety', ar: 'Ø§Ù„Ø³Ù„Ø§Ù…Ø© Ù…Ù† Ø§Ù„Ø­Ø±ÙŠÙ‚' }, icon: 'ğŸ”¥' },
                    { id: 'medical', title: { en: 'Medical Emergencies', ar: 'Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ Ø§Ù„Ø·Ø¨ÙŠØ©' }, icon: 'ğŸš‘' }
                ],
                topics: {
                    en: ['Emergency evacuation routes', 'Fire extinguisher types', 'CPR procedure steps', 'Active shooter response'],
                    ar: ['Ø·Ø±Ù‚ Ø§Ù„Ø¥Ø®Ù„Ø§Ø¡ ÙÙŠ Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø·ÙˆØ§Ø±Ø¦', 'Ø£Ù†ÙˆØ§Ø¹ Ø·ÙØ§ÙŠØ§Øª Ø§Ù„Ø­Ø±ÙŠÙ‚']
                },
                keywords: ['evacuation', 'fire', 'first aid', 'cpr', 'emergency', 'medical', 'safety', 'protocol', 'drill', 'extinguisher', 'assembly'],
                quizQuestions: [
                    { 
                        question: { en: 'What does PASS stand for?', ar: 'Ù…Ø§Ø°Ø§ ØªØ¹Ù†ÙŠ PASSØŸ' },
                        options: { en: ['Push, Aim, Squeeze, Sweep', 'Pull, Aim, Squeeze, Sweep', 'Pull, Attack, Spray, Stop', 'Push, Alert, Spray, Stop'], ar: ['Ø§Ø¶ØºØ·ØŒ ØµÙˆÙ‘Ø¨ØŒ Ø§Ø¹ØµØ±ØŒ Ø§Ù…Ø³Ø­', 'Ø§Ø³Ø­Ø¨ØŒ ØµÙˆÙ‘Ø¨ØŒ Ø§Ø¹ØµØ±ØŒ Ø§Ù…Ø³Ø­', 'Ø§Ø³Ø­Ø¨ØŒ Ù‡Ø§Ø¬Ù…ØŒ Ø±Ø´ØŒ ØªÙˆÙ‚Ù', 'Ø§Ø¶ØºØ·ØŒ Ù†Ø¨Ù‘Ù‡ØŒ Ø±Ø´ØŒ ØªÙˆÙ‚Ù'] },
                        correct: 1,
                        explanation: { en: 'PASS: Pull the pin, Aim at base, Squeeze handle, Sweep side to side.', ar: 'PASS: Ø§Ø³Ø­Ø¨ Ø§Ù„Ù…Ø³Ù…Ø§Ø±ØŒ ØµÙˆÙ‘Ø¨ Ù†Ø­Ùˆ Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©ØŒ Ø§Ø¹ØµØ± Ø§Ù„Ù…Ù‚Ø¨Ø¶ØŒ Ø§Ù…Ø³Ø­ Ù…Ù† Ø¬Ø§Ù†Ø¨ Ù„Ø¢Ø®Ø±.' }
                    }
                ],
                responses: { en: {}, ar: {} }
            },
            leadership: {
                id: 'leadership',
                title: { en: 'Leadership & Command', ar: 'Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© ÙˆØ§Ù„Ø¥Ø¯Ø§Ø±Ø©' },
                subtitle: { en: 'Strategic Leadership Development', ar: 'ØªØ·ÙˆÙŠØ± Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©' },
                icon: 'ğŸ‘”',
                outline: [
                    { id: 'principles', title: { en: 'Leadership Principles', ar: 'Ù…Ø¨Ø§Ø¯Ø¦ Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©' }, icon: 'â­' },
                    { id: 'decisions', title: { en: 'Decision Making', ar: 'Ø§ØªØ®Ø§Ø° Ø§Ù„Ù‚Ø±Ø§Ø±Ø§Øª' }, icon: 'ğŸ¯' },
                    { id: 'teams', title: { en: 'Team Building', ar: 'Ø¨Ù†Ø§Ø¡ Ø§Ù„ÙØ±ÙŠÙ‚' }, icon: 'ğŸ¤' },
                    { id: 'communication', title: { en: 'Effective Communication', ar: 'Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„ÙØ¹Ø§Ù„' }, icon: 'ğŸ’¬' },
                    { id: 'conflict', title: { en: 'Conflict Resolution', ar: 'Ø­Ù„ Ø§Ù„Ù†Ø²Ø§Ø¹Ø§Øª' }, icon: 'âš–ï¸' }
                ],
                topics: {
                    en: ['Leadership styles overview', 'Making decisions under pressure', 'Building high-performance teams', 'Giving effective feedback'],
                    ar: ['Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©', 'Ø§ØªØ®Ø§Ø° Ø§Ù„Ù‚Ø±Ø§Ø±Ø§Øª ØªØ­Øª Ø§Ù„Ø¶ØºØ·']
                },
                keywords: ['leadership', 'leader', 'team', 'management', 'decision', 'strategy', 'motivation', 'delegate', 'feedback', 'conflict', 'communication'],
                quizQuestions: [
                    { 
                        question: { en: 'Which leadership style involves team input?', ar: 'Ø£ÙŠ Ù†Ù…Ø· Ù‚ÙŠØ§Ø¯ÙŠ ÙŠØªØ¶Ù…Ù† Ù…Ø¯Ø®Ù„Ø§Øª Ø§Ù„ÙØ±ÙŠÙ‚ØŸ' },
                        options: { en: ['Autocratic', 'Democratic', 'Laissez-faire', 'Transactional'], ar: ['Ø§Ø³ØªØ¨Ø¯Ø§Ø¯ÙŠ', 'Ø¯ÙŠÙ…Ù‚Ø±Ø§Ø·ÙŠ', 'Ø¹Ø¯Ù… Ø§Ù„ØªØ¯Ø®Ù„', 'ØªØ¨Ø§Ø¯Ù„ÙŠ'] },
                        correct: 1,
                        explanation: { en: 'Democratic leadership involves consulting team members in decisions.', ar: 'Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© Ø§Ù„Ø¯ÙŠÙ…Ù‚Ø±Ø§Ø·ÙŠØ© ØªØªØ¶Ù…Ù† Ø§Ø³ØªØ´Ø§Ø±Ø© Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„ÙØ±ÙŠÙ‚ ÙÙŠ Ø§Ù„Ù‚Ø±Ø§Ø±Ø§Øª.' }
                    }
                ],
                responses: { en: {}, ar: {} }
            }
        };

        // ============================================
        // GUIDED LEARNING SUGGESTIONS (Option D)
        // ============================================
        const GUIDED_SUGGESTIONS = {
            en: [
                { label: 'ğŸ­ Real-world scenario', prompt: 'Give me a real-world scenario about {topic}' },
                { label: 'ğŸ“ Quick quiz', prompt: 'Ask me a quiz question about {topic}' },
                { label: 'ğŸ“‹ 3 bullet summary', prompt: 'Summarize {topic} in 3 bullet points' },
                { label: 'ğŸ‡¦ğŸ‡ª UAE context', prompt: 'How does {topic} apply in the UAE context?' },
                { label: 'ğŸ”‘ Key takeaways', prompt: 'What are the key takeaways from {topic}?' }
            ],
            ar: [
                { label: 'ğŸ­ Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ ÙˆØ§Ù‚Ø¹ÙŠ', prompt: 'Ø£Ø¹Ø·Ù†ÙŠ Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ ÙˆØ§Ù‚Ø¹ÙŠ Ø¹Ù† {topic}' },
                { label: 'ğŸ“ Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹', prompt: 'Ø§Ø³Ø£Ù„Ù†ÙŠ Ø³Ø¤Ø§Ù„ Ø§Ø®ØªØ¨Ø§Ø± Ø¹Ù† {topic}' },
                { label: 'ğŸ“‹ Ù…Ù„Ø®Øµ 3 Ù†Ù‚Ø§Ø·', prompt: 'Ù„Ø®Øµ {topic} ÙÙŠ 3 Ù†Ù‚Ø§Ø·' },
                { label: 'ğŸ‡¦ğŸ‡ª Ø§Ù„Ø³ÙŠØ§Ù‚ Ø§Ù„Ø¥Ù…Ø§Ø±Ø§ØªÙŠ', prompt: 'ÙƒÙŠÙ ÙŠÙ†Ø·Ø¨Ù‚ {topic} ÙÙŠ Ø§Ù„Ø³ÙŠØ§Ù‚ Ø§Ù„Ø¥Ù…Ø§Ø±Ø§ØªÙŠØŸ' },
                { label: 'ğŸ”‘ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©', prompt: 'Ù…Ø§ Ù‡ÙŠ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù…Ù† {topic}?' }
            ]
        };

        // ============================================
        // TRANSLATIONS
        // ============================================
        const translations = {
            en: {
                title: 'Prometheus AI Tutor',
                subtitle: 'Rabdan Academy â€” Intelligent Training System',
                inputPlaceholder: 'Ask me anything about the training module...',
                quickTopics: 'Quick Topics',
                chatTitle: 'ğŸ’¬ Learning Conversation',
                clear: 'ğŸ—‘ï¸ Clear',
                voiceOn: 'ğŸ”Š Voice On',
                voiceOff: 'ğŸ”‡ Voice Off',
                progress: 'ğŸ“Š Your Progress',
                moduleCompletion: 'Module Completion',
                questions: 'Questions',
                quizScore: 'Quiz Score',
                chapters: 'Chapters',
                level: 'Level',
                courseOutline: 'ğŸ“‹ Course Outline',
                learnMode: 'ğŸ“š Learn',
                quizMode: 'â“ Quiz',
                resetDemo: 'â†» Reset Demo',
                apiSettings: 'ğŸ”’ API Settings',
                welcome: "Welcome! I'm your AI tutor for **{module}**. How can I help you learn today?",
                helpful: 'ğŸ‘ Helpful',
                save: 'ğŸ”– Save',
                copy: 'ğŸ“‹ Copy',
                listen: 'ğŸ”Š Listen',
                askSection: 'Ask',
                quizQuestion: 'ğŸ“ Quiz Question',
                correct: 'âœ“ Correct!',
                incorrect: 'âœ— Incorrect',
                nextQuestion: 'Next Question â†’',
                seeResults: 'See Results',
                quizComplete: '**Quiz Complete!**',
                excellentWork: 'Excellent work!',
                goodEffort: 'Good effort!',
                keepStudying: 'Keep studying!',
                online: 'Online & Ready',
                topicDetected: 'Topic: {module} â†’ {topic}',
                generalTopic: 'Topic: General training question',
                levelUp: 'Level Up! You reached Level {level}!'
            },
            ar: {
                title: 'Ø¨Ø±ÙˆÙ…ÙŠØ«ÙŠÙˆØ³ Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ø°ÙƒÙŠ',
                subtitle: 'Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© Ø±Ø¨Ø¯Ø§Ù† â€” Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø°ÙƒÙŠ',
                inputPlaceholder: 'Ø§Ø³Ø£Ù„Ù†ÙŠ Ø£ÙŠ Ø´ÙŠØ¡ Ø¹Ù† Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠØ©...',
                quickTopics: 'Ù…ÙˆØ§Ø¶ÙŠØ¹ Ø³Ø±ÙŠØ¹Ø©',
                chatTitle: 'ğŸ’¬ Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„ØªØ¹Ù„Ù…',
                clear: 'ğŸ—‘ï¸ Ù…Ø³Ø­',
                voiceOn: 'ğŸ”Š Ø§Ù„ØµÙˆØª Ù…ÙØ¹Ù„',
                voiceOff: 'ğŸ”‡ Ø§Ù„ØµÙˆØª Ù…ØºÙ„Ù‚',
                progress: 'ğŸ“Š ØªÙ‚Ø¯Ù…Ùƒ',
                moduleCompletion: 'Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„ÙˆØ­Ø¯Ø©',
                questions: 'Ø§Ù„Ø£Ø³Ø¦Ù„Ø©',
                quizScore: 'Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±',
                chapters: 'Ø§Ù„ÙØµÙˆÙ„',
                level: 'Ø§Ù„Ù…Ø³ØªÙˆÙ‰',
                courseOutline: 'ğŸ“‹ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¯ÙˆØ±Ø©',
                learnMode: 'ğŸ“š ØªØ¹Ù„Ù…',
                quizMode: 'â“ Ø§Ø®ØªØ¨Ø§Ø±',
                resetDemo: 'â†» Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†',
                apiSettings: 'ğŸ”’ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª API',
                welcome: "Ù…Ø±Ø­Ø¨Ø§Ù‹! Ø£Ù†Ø§ Ù…Ø¹Ù„Ù…Ùƒ Ø§Ù„Ø°ÙƒÙŠ Ù„Ù€ **{module}**. ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ ÙÙŠ Ø§Ù„ØªØ¹Ù„Ù… Ø§Ù„ÙŠÙˆÙ…ØŸ",
                helpful: 'ğŸ‘ Ù…ÙÙŠØ¯',
                save: 'ğŸ”– Ø­ÙØ¸',
                copy: 'ğŸ“‹ Ù†Ø³Ø®',
                listen: 'ğŸ”Š Ø§Ø³ØªÙ…Ø¹',
                askSection: 'Ø§Ø³Ø£Ù„',
                quizQuestion: 'ğŸ“ Ø³Ø¤Ø§Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±',
                correct: 'âœ“ ØµØ­ÙŠØ­!',
                incorrect: 'âœ— Ø®Ø·Ø£',
                nextQuestion: 'Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ â†',
                seeResults: 'Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬',
                quizComplete: '**Ø§ÙƒØªÙ…Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±!**',
                excellentWork: 'Ø¹Ù…Ù„ Ù…Ù…ØªØ§Ø²!',
                goodEffort: 'Ø¬Ù‡Ø¯ Ø¬ÙŠØ¯!',
                keepStudying: 'Ø§Ø³ØªÙ…Ø± ÙÙŠ Ø§Ù„Ø¯Ø±Ø§Ø³Ø©!',
                online: 'Ù…ØªØµÙ„ ÙˆØ¬Ø§Ù‡Ø²',
                topicDetected: 'Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹: {module} â† {topic}',
                generalTopic: 'Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹: Ø³Ø¤Ø§Ù„ ØªØ¯Ø±ÙŠØ¨ÙŠ Ø¹Ø§Ù…',
                levelUp: 'ØªØ±Ù‚ÙŠØ©! ÙˆØµÙ„Øª Ù„Ù„Ù…Ø³ØªÙˆÙ‰ {level}!'
            }
        };

        // ============================================
        // VOICE INTEGRATION (Browser STT + TTS)
        // ============================================
        let recognition = null;
        let voicesLoaded = false;

        // Preload voices
        if (typeof speechSynthesis !== 'undefined') {
            // Trigger loading
            speechSynthesis.getVoices();
            speechSynthesis.onvoiceschanged = () => {
                voicesLoaded = true;
                console.log('Voices loaded:', speechSynthesis.getVoices().length);
            };
        }

        function initSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SR();
                recognition.continuous = false;
                recognition.interimResults = true;

                recognition.onresult = (e) => {
                    const transcript = e.results[0][0].transcript;
                    document.getElementById('message-input').value = transcript;
                };

                recognition.onend = () => {
                    if (state.isRecording) {
                        state.isRecording = false;
                        document.getElementById('voice-btn').classList.remove('recording');
                        const input = document.getElementById('message-input').value.trim();
                        if (input) sendMessage();
                    }
                };

                recognition.onerror = () => {
                    state.isRecording = false;
                    document.getElementById('voice-btn').classList.remove('recording');
                    showToast(state.currentLang === 'ar'
                        ? 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª'
                        : 'Voice recognition error', 'error');
                };
            }
        }

        function toggleVoiceInput() {
            if (!recognition) {
                showToast(state.currentLang === 'ar'
                    ? 'Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­'
                    : 'Voice input not supported in this browser', 'error');
                return;
            }

            if (state.isRecording) {
                recognition.stop();
                state.isRecording = false;
                document.getElementById('voice-btn').classList.remove('recording');
            } else {
                recognition.lang = state.currentLang === 'ar' ? 'ar-AE' : 'en-US';
                recognition.start();
                state.isRecording = true;
                document.getElementById('voice-btn').classList.add('recording');
            }
        }

        function toggleSpeaker() {
            state.speakerEnabled = !state.speakerEnabled;
            const t = translations[state.currentLang];
            document.getElementById('speaker-btn').textContent =
                state.speakerEnabled ? t.voiceOn : t.voiceOff;

            showToast(
                state.speakerEnabled
                    ? (state.currentLang === 'ar' ? 'ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª' : 'Voice enabled')
                    : (state.currentLang === 'ar' ? 'ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØµÙˆØª' : 'Voice disabled'),
                'success'
            );

            if (!state.speakerEnabled) {
                stopSpeech();
            }
        }

        // Pick best voice for a language (tries male if possible)
        function getBestVoice(lang) {
            if (typeof speechSynthesis === 'undefined') return null;

            const voices = speechSynthesis.getVoices();
            if (!voices || !voices.length) return null;

            if (lang === 'ar') {
                // For Arabic: Prioritize MSA voices (Saudi, Egyptian)
                const msaPreference = ['ar-SA', 'ar-EG', 'ar-XA', 'ar'];
                
                // First try to find MSA male voice
                for (const code of msaPreference) {
                    const maleVoice = voices.find(v => {
                        if (!v || !v.lang || !v.name) return false;
                        const name = v.name.toLowerCase();
                        return v.lang.toLowerCase().startsWith(code.toLowerCase()) &&
                            (name.includes('male') ||
                             name.includes('ahmed') ||
                             name.includes('majed') ||
                             name.includes('omar') ||
                             name.includes('tarik'));
                    });
                    if (maleVoice) {
                        console.log('Found MSA male voice:', maleVoice.name, maleVoice.lang);
                        return maleVoice;
                    }
                }
                
                // Then try any MSA voice
                for (const code of msaPreference) {
                    const msaVoice = voices.find(v => 
                        v && v.lang && v.lang.toLowerCase().startsWith(code.toLowerCase())
                    );
                    if (msaVoice) {
                        console.log('Found MSA voice:', msaVoice.name, msaVoice.lang);
                        return msaVoice;
                    }
                }
                
                // Fallback to any Arabic voice
                const anyArabic = voices.find(v => v && v.lang && v.lang.toLowerCase().startsWith('ar'));
                if (anyArabic) {
                    console.log('Using fallback Arabic voice:', anyArabic.name, anyArabic.lang);
                    return anyArabic;
                }
                
                return null;
            }

            // For English: prefer male voices
            const langCode = 'en';
            let preferred = voices.find(v => {
                if (!v || !v.lang || !v.name) return false;
                const name = v.name.toLowerCase();
                return v.lang.toLowerCase().startsWith(langCode) &&
                    (name.includes('male') ||
                     name.includes('david') ||
                     name.includes('james') ||
                     name.includes('daniel'));
            });

            // Fallback: any voice with that language
            if (!preferred) {
                preferred = voices.find(v => v && v.lang && v.lang.toLowerCase().startsWith(langCode));
            }

            return preferred || null;
        }

        // Main TTS function â€“ Browser TTS only
        function speakText(text) {
            if (!state.speakerEnabled) return;
            if (typeof speechSynthesis === 'undefined') {
                console.warn('speechSynthesis not supported');
                return;
            }

            // Clean previous speech
            stopSpeech();

            const cleanText = text
                .replace(/\*\*/g, '')   // remove markdown bold
                .replace(/\n/g, ' ')
                .replace(/â€¢/g, '')
                .trim();

            if (!cleanText) return;

            const avatar = document.getElementById('avatar-container');
            if (avatar) avatar.classList.add('speaking');

            const isArabic =
                state.currentLang === 'ar' || /[\u0600-\u06FF]/.test(cleanText);

            const utterance = new SpeechSynthesisUtterance(cleanText);
            utterance.lang = isArabic ? 'ar-SA' : 'en-GB';  // MSA (Saudi) for Arabic, British for English
            utterance.rate = isArabic ? 1.0 : 0.95;
            utterance.pitch = 1.0;

            const voice = getBestVoice(isArabic ? 'ar' : 'en');
            if (voice) {
                utterance.voice = voice;
                console.log('Using voice:', voice.name, voice.lang);
            } else {
                console.log('No matching voice found, using default TTS voice');
            }

            utterance.onend = () => {
                if (avatar) avatar.classList.remove('speaking');
            };

            utterance.onerror = (e) => {
                console.error('Speech error:', e);
                if (avatar) avatar.classList.remove('speaking');
                showToast(
                    state.currentLang === 'ar'
                        ? 'ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª'
                        : 'Could not play audio',
                    'error'
                );
            };

            speechSynthesis.speak(utterance);
        }

        function stopSpeech() {
            try {
                if (typeof speechSynthesis !== 'undefined') {
                    speechSynthesis.cancel();
                }
            } catch (e) {
                console.warn('Error stopping speech:', e);
            }
            const avatar = document.getElementById('avatar-container');
            if (avatar) avatar.classList.remove('speaking');
        }

        // ============================================
        // DYNAMIC TOPIC DETECTION (Option B)
        // ============================================
        function detectTopic(question) {
            const lowerQ = question.toLowerCase();
            let detectedModule = null;
            let detectedTopic = null;
            let maxMatches = 0;

            // Check each module's keywords
            for (const [moduleId, module] of Object.entries(MODULES)) {
                let matches = 0;
                for (const keyword of module.keywords) {
                    if (lowerQ.includes(keyword.toLowerCase())) {
                        matches++;
                    }
                }
                if (matches > maxMatches) {
                    maxMatches = matches;
                    detectedModule = moduleId;
                }
            }

            // If detected module, find specific topic/chapter
            if (detectedModule) {
                const module = MODULES[detectedModule];
                for (const chapter of module.outline) {
                    const chapterTitle = chapter.title[state.currentLang].toLowerCase();
                    if (lowerQ.includes(chapterTitle) || chapterTitle.split(' ').some(w => lowerQ.includes(w) && w.length > 3)) {
                        detectedTopic = chapter.title[state.currentLang];
                        break;
                    }
                }
                if (!detectedTopic) {
                    detectedTopic = module.title[state.currentLang];
                }
            }

            state.lastDetectedTopic = { module: detectedModule, topic: detectedTopic };
            return { module: detectedModule, topic: detectedTopic };
        }

        function getTopicLabel(detected) {
            const t = translations[state.currentLang];
            if (detected.module && detected.topic) {
                const moduleName = MODULES[detected.module].title[state.currentLang];
                return t.topicDetected
                    .replace('{module}', moduleName.split(' ')[0])
                    .replace('{topic}', detected.topic);
            }
            return t.generalTopic;
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', function () {
            loadSettings();
            changeModule();
            initSpeechRecognition();
            updateStatsDisplay();
        });

        function loadSettings() {
            state.apiKey = localStorage.getItem('prometheus_api_key') || '';
            document.getElementById('api-key-input').value = state.apiKey;
        }

        // ============================================
        // MODULE MANAGEMENT (Option A)
        // ============================================
        function changeModule() {
            const select = document.getElementById('module-select');
            state.currentModule = select.value;
            const module = MODULES[state.currentModule];

            document.getElementById('module-title').textContent = module.title[state.currentLang];
            document.getElementById('module-subtitle').textContent = module.subtitle[state.currentLang];
            document.querySelector('.module-banner-icon').textContent = module.icon;

            renderCourseOutline();
            renderQuickTopics();

            state.messages = [];
            document.getElementById('messages-area').innerHTML = '';
            addWelcomeMessage();
            state.currentQuiz = null;
            state.currentChapter = null;
        }

        function renderCourseOutline() {
            const module = MODULES[state.currentModule];
            const container = document.getElementById('course-outline');
            const t = translations[state.currentLang];

            // Initialize visited tracking for this module
            if (!state.visitedChapters[state.currentModule]) {
                state.visitedChapters[state.currentModule] = [];
            }

            container.innerHTML = module.outline.map((item, i) => {
                const isVisited = state.visitedChapters[state.currentModule].includes(item.id);
                const isActive = state.currentChapter === item.id;
                return `
                    <div class="outline-item ${isActive ? 'active' : ''} ${isVisited ? 'visited' : ''}" 
                         onclick="selectChapter('${item.id}', this)">
                        <div class="outline-icon">${isVisited ? 'âœ“' : item.icon}</div>
                        <span class="outline-text">${item.title[state.currentLang]}</span>
                        <button class="outline-ask-btn" onclick="event.stopPropagation(); askAboutChapter('${item.id}')">${t.askSection}</button>
                    </div>
                `;
            }).join('');

            updateProgress();
        }

        function selectChapter(chapterId, element) {
            document.querySelectorAll('.outline-item').forEach(el => el.classList.remove('active'));
            element.classList.add('active');
            state.currentChapter = chapterId;

            // Mark as visited
            if (!state.visitedChapters[state.currentModule].includes(chapterId)) {
                state.visitedChapters[state.currentModule].push(chapterId);
                localStorage.setItem('prometheus_visited', JSON.stringify(state.visitedChapters));
                renderCourseOutline();
            }

            const module = MODULES[state.currentModule];
            const chapter = module.outline.find(c => c.id === chapterId);
            if (chapter) {
                const prompt = state.currentLang === 'ar'
                    ? `Ø£Ø®Ø¨Ø±Ù†ÙŠ Ø¹Ù† ${chapter.title.ar}`
                    : `Tell me about ${chapter.title.en}`;
                document.getElementById('message-input').value = prompt;
                sendMessage();
            }
        }

        function askAboutChapter(chapterId) {
            const module = MODULES[state.currentModule];
            const chapter = module.outline.find(c => c.id === chapterId);
            if (chapter) {
                const prompt = state.currentLang === 'ar'
                    ? `Ø§Ø´Ø±Ø­ Ø§Ù„Ù…ÙØ§Ù‡ÙŠÙ… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ù€ ${chapter.title.ar} Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø¨Ø³ÙŠØ·Ø©`
                    : `Explain the key concepts of ${chapter.title.en} in simple terms`;
                document.getElementById('message-input').value = prompt;
                sendMessage();
            }
        }

        function renderQuickTopics() {
            const module = MODULES[state.currentModule];
            const topics = module.topics[state.currentLang];
            document.getElementById('topics-grid').innerHTML = topics.map(topic =>
                `<button class="topic-chip" onclick="askTopic('${topic.replace(/'/g, "\\'")}')">${topic}</button>`
            ).join('');
        }

        function askTopic(topic) {
            document.getElementById('message-input').value = topic;
            sendMessage();
        }

        // ============================================
        // MESSAGING
        // ============================================
        function addWelcomeMessage() {
            const module = MODULES[state.currentModule];
            const t = translations[state.currentLang];
            const text = t.welcome.replace('{module}', module.title[state.currentLang]);
            addMessage('assistant', text, false);
        }

        function addMessage(role, text, addToHistory = true, detectedTopic = null) {
            const area = document.getElementById('messages-area');
            const div = document.createElement('div');
            div.className = `message ${role}`;
            const t = translations[state.currentLang];

            const formatted = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');

            // Generate topic label for detection
            let topicLabelHtml = '';
            if (role === 'assistant' && detectedTopic) {
                topicLabelHtml = `<div class="topic-label">${getTopicLabel(detectedTopic)}</div>`;
            }

            // Generate guided follow-ups (Option D)
            let followUpsHtml = '';
            if (role === 'assistant' && state.lastDetectedTopic?.topic) {
                const suggestions = GUIDED_SUGGESTIONS[state.currentLang];
                const topic = state.lastDetectedTopic.topic;
                followUpsHtml = `
                    <div class="follow-ups">
                        ${suggestions.slice(0, 4).map(s => `
                            <button class="follow-up-btn guided" 
                                    onclick="askGuidedFollowUp('${s.prompt.replace('{topic}', topic).replace(/'/g, "\\'")}')">${s.label}</button>
                        `).join('')}
                    </div>
                    <div class="level-indicator">
                        <span>ğŸ“ˆ</span>
                        <span class="level-badge">Level ${state.stats.level}</span>
                        <span>${state.stats.questions} questions asked</span>
                    </div>
                `;
            }

            div.innerHTML = `
                <div class="message-avatar">${role === 'assistant' ? 'ğŸ¤–' : 'ğŸ‘¤'}</div>
                <div class="message-content">
                    <div class="message-text">${formatted}</div>
                    ${topicLabelHtml}
                    ${role === 'assistant' ? `
                        <div class="message-actions">
                            <button class="msg-action-btn" onclick="toggleLike(this)">${t.helpful}</button>
                            <button class="msg-action-btn" onclick="copyText(\`${text.replace(/`/g, '\\`')}\`)">${t.copy}</button>
                            <button class="msg-action-btn" onclick="speakText(\`${text.replace(/`/g, '\\`')}\`)">${t.listen}</button>
                        </div>
                        ${followUpsHtml}
                    ` : ''}
                </div>
            `;

            area.appendChild(div);
            area.scrollTop = area.scrollHeight;

            if (addToHistory) {
                state.messages.push({ role, text, timestamp: Date.now() });
                if (role === 'user') addToHistoryPanel(text);
            }

            if (role === 'assistant' && state.speakerEnabled) {
                speakText(text);
            }
        }

        function askGuidedFollowUp(prompt) {
            document.getElementById('message-input').value = prompt;
            sendMessage();
        }

        function sendMessage() {
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            if (!text) return;

            // Detect topic (Option B)
            const detected = detectTopic(text);

            addMessage('user', text);
            input.value = '';

            state.stats.questions++;
            checkLevelUp();
            updateStatsDisplay();

            showTypingIndicator();

            setTimeout(() => {
                hideTypingIndicator();
                if (state.apiKey) {
                    callClaudeAPI(text, detected);
                } else {
                    const response = getMockResponse(text);
                    addMessage('assistant', response, true, detected);
                }
            }, 800 + Math.random() * 800);
        }

        function getMockResponse(question) {
            const module = MODULES[state.currentModule];
            const responses = module.responses[state.currentLang];

            // Check for exact match
            if (responses && responses[question]) {
                return responses[question];
            }

            // Default responses
            const defaults = {
                en: [
                    "That's an excellent question! This is an important aspect of our training module. Let me provide you with comprehensive information.",
                    "Great thinking! Understanding this concept is crucial for your professional development in this field.",
                    "Good question! Here's what you need to know about this subject area."
                ],
                ar: [
                    "Ø³Ø¤Ø§Ù„ Ù…Ù…ØªØ§Ø²! Ù‡Ø°Ø§ Ø¬Ø§Ù†Ø¨ Ù…Ù‡Ù… Ù…Ù† ÙˆØ­Ø¯ØªÙ†Ø§ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠØ©. Ø¯Ø¹Ù†ÙŠ Ø£Ù‚Ø¯Ù… Ù„Ùƒ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø´Ø§Ù…Ù„Ø©.",
                    "ØªÙÙƒÙŠØ± Ø±Ø§Ø¦Ø¹! ÙÙ‡Ù… Ù‡Ø°Ø§ Ø§Ù„Ù…ÙÙ‡ÙˆÙ… Ø£Ù…Ø± Ø¨Ø§Ù„Øº Ø§Ù„Ø£Ù‡Ù…ÙŠØ© Ù„ØªØ·ÙˆÙŠØ±Ùƒ Ø§Ù„Ù…Ù‡Ù†ÙŠ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¬Ø§Ù„.",
                    "Ø³Ø¤Ø§Ù„ Ø¬ÙŠØ¯! Ø¥Ù„ÙŠÙƒ Ù…Ø§ ØªØ­ØªØ§Ø¬ Ù…Ø¹Ø±ÙØªÙ‡ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹."
                ]
            };

            return defaults[state.currentLang][Math.floor(Math.random() * defaults[state.currentLang].length)];
        }

        async function callClaudeAPI(question, detected) {
            const module = MODULES[state.currentModule];
            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': state.apiKey,
                        'anthropic-version': '2023-06-01',
                        'anthropic-dangerous-direct-browser-access': 'true'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1024,
                        system: `You are an AI tutor for ${module.title[state.currentLang]} at Rabdan Academy, UAE. Be professional, helpful, engaging. Use **bold** for emphasis. Language: ${state.currentLang === 'ar' ? 'Arabic' : 'English'}. ${detected.topic ? `Current topic context: ${detected.topic}` : ''}`,
                        messages: [{ role: 'user', content: question }]
                    })
                });
                const data = await response.json();
                if (data.content?.[0]) {
                    addMessage('assistant', data.content[0].text, true, detected);
                } else {
                    throw new Error('Invalid response');
                }
            } catch (e) {
                addMessage('assistant', getMockResponse(question), true, detected);
            }
        }

        function showTypingIndicator() {
            const area = document.getElementById('messages-area');
            const div = document.createElement('div');
            div.className = 'message assistant';
            div.id = 'typing-indicator';
            div.innerHTML = `<div class="message-avatar">ğŸ¤–</div><div class="message-content"><div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div></div>`;
            area.appendChild(div);
            area.scrollTop = area.scrollHeight;
        }

        function hideTypingIndicator() {
            document.getElementById('typing-indicator')?.remove();
        }

        function clearChat() {
            state.messages = [];
            document.getElementById('messages-area').innerHTML = '';
            addWelcomeMessage();
            showToast(state.currentLang === 'ar' ? 'ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©' : 'Chat cleared', 'success');
        }

        // ============================================
        // QUIZ MODE
        // ============================================
        function setMode(mode) {
            state.currentMode = mode;
            document.getElementById('learn-mode-btn').classList.toggle('active', mode === 'learn');
            document.getElementById('quiz-mode-btn').classList.toggle('active', mode === 'quiz');
            if (mode === 'quiz') startQuiz();
        }

        function startQuiz() {
            const module = MODULES[state.currentModule];
            const questions = [...module.quizQuestions];
            for (let i = questions.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [questions[i], questions[j]] = [questions[j], questions[i]];
            }
            state.currentQuiz = { questions, currentIndex: 0, score: 0, answered: false };
            showQuizQuestion();
        }

        function showQuizQuestion() {
            const quiz = state.currentQuiz;
            const q = quiz.questions[quiz.currentIndex];
            const area = document.getElementById('messages-area');
            const t = translations[state.currentLang];

            const div = document.createElement('div');
            div.className = 'quiz-container';
            div.id = 'current-quiz';
            div.innerHTML = `
                <div class="quiz-header">
                    <span class="quiz-title">${t.quizQuestion}</span>
                    <span class="quiz-progress">${quiz.currentIndex + 1} / ${quiz.questions.length}</span>
                </div>
                <div class="quiz-question">${q.question[state.currentLang]}</div>
                <div class="quiz-options">
                    ${q.options[state.currentLang].map((opt, i) => `<button class="quiz-option" onclick="answerQuiz(${i})">${opt}</button>`).join('')}
                </div>
            `;
            area.appendChild(div);
            area.scrollTop = area.scrollHeight;
        }

        function answerQuiz(idx) {
            if (state.currentQuiz.answered) return;
            state.currentQuiz.answered = true;

            const quiz = state.currentQuiz;
            const q = quiz.questions[quiz.currentIndex];
            const isCorrect = idx === q.correct;
            const t = translations[state.currentLang];

            const options = document.querySelectorAll('.quiz-option');
            options.forEach((opt, i) => {
                opt.style.pointerEvents = 'none';
                if (i === q.correct) opt.classList.add('correct');
                else if (i === idx && !isCorrect) opt.classList.add('incorrect');
            });

            if (isCorrect) {
                quiz.score++;
                state.stats.quizCorrect++;
            }
            state.stats.quizTotal++;

            const container = document.getElementById('current-quiz');
            container.innerHTML += `
                <div class="quiz-feedback ${isCorrect ? 'correct' : 'incorrect'}">
                    <strong>${isCorrect ? t.correct : t.incorrect}</strong><br>${q.explanation[state.currentLang]}
                </div>
                <button class="quiz-next-btn" onclick="nextQuizQuestion()">
                    ${quiz.currentIndex < quiz.questions.length - 1 ? t.nextQuestion : t.seeResults}
                </button>
            `;

            updateStatsDisplay();
        }

        function nextQuizQuestion() {
            const quiz = state.currentQuiz;
            const t = translations[state.currentLang];
            document.getElementById('current-quiz').remove();

            if (quiz.currentIndex < quiz.questions.length - 1) {
                quiz.currentIndex++;
                quiz.answered = false;
                showQuizQuestion();
            } else {
                const pct = Math.round((quiz.score / quiz.questions.length) * 100);
                const emoji = pct >= 80 ? 'ğŸ‰' : pct >= 60 ? 'ğŸ‘' : 'ğŸ“š';
                const feedback = pct >= 80 ? t.excellentWork : pct >= 60 ? t.goodEffort : t.keepStudying;
                addMessage('assistant', `${emoji} ${t.quizComplete}\n\n${state.currentLang === 'ar' ? 'Ø­ØµÙ„Øª Ø¹Ù„Ù‰' : 'You scored'} **${quiz.score}/${quiz.questions.length}** (${pct}%)\n\n${feedback}`);
                setMode('learn');
            }
        }

        // ============================================
        // LANGUAGE
        // ============================================
        function setLanguage(lang) {
            state.currentLang = lang;
            const t = translations[lang];
            const isArabic = lang === 'ar';

            document.getElementById('lang-en').classList.toggle('active', lang === 'en');
            document.getElementById('lang-ar').classList.toggle('active', lang === 'ar');

            document.body.style.direction = isArabic ? 'rtl' : 'ltr';
            document.body.style.textAlign = isArabic ? 'right' : 'left';

            document.querySelector('.header-text h1').textContent = t.title;
            document.querySelector('.header-subtitle').textContent = t.subtitle;

            const module = MODULES[state.currentModule];
            document.getElementById('module-title').textContent = module.title[lang];
            document.getElementById('module-subtitle').textContent = module.subtitle[lang];

            document.getElementById('message-input').placeholder = t.inputPlaceholder;
            document.getElementById('topics-label').textContent = t.quickTopics;
            document.getElementById('chat-title').textContent = t.chatTitle;
            document.getElementById('learn-mode-btn').innerHTML = t.learnMode;
            document.getElementById('quiz-mode-btn').innerHTML = t.quizMode;
            document.getElementById('progress-title').textContent = t.progress;
            document.getElementById('progress-label').textContent = t.moduleCompletion;
            document.getElementById('outline-title').textContent = t.courseOutline;
            document.getElementById('status-text').textContent = t.online;
            document.getElementById('label-questions').textContent = t.questions;
            document.getElementById('label-quiz').textContent = t.quizScore;
            document.getElementById('label-chapters').textContent = t.chapters;
            document.getElementById('label-level').textContent = t.level;

            renderCourseOutline();
            renderQuickTopics();

            showToast(isArabic ? 'ØªÙ… Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©' : 'Switched to English', 'success');
        }

        function resetDemo() {
            state.messages = [];
            state.history = [];
            state.stats = { questions: 0, quizCorrect: 0, quizTotal: 0, level: 1 };
            state.currentQuiz = null;
            state.visitedChapters = {};
            localStorage.setItem('prometheus_visited', '{}');

            document.getElementById('messages-area').innerHTML = '';
            changeModule();
            updateStatsDisplay();
            renderHistoryPanel();

            showToast(state.currentLang === 'ar' ? 'ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠ' : 'Demo reset successfully', 'success');
        }

        // ============================================
        // PANELS
        // ============================================
        function togglePanel(id) {
            const panel = document.getElementById(`${id}-panel`);
            const overlay = document.getElementById('overlay');
            const isOpen = panel.classList.contains('open');

            document.querySelectorAll('.side-panel').forEach(p => p.classList.remove('open'));
            overlay.classList.remove('show');

            if (!isOpen) {
                panel.classList.add('open');
                overlay.classList.add('show');
            }
        }

        function closeAllPanels() {
            document.querySelectorAll('.side-panel').forEach(p => p.classList.remove('open'));
            document.getElementById('overlay').classList.remove('show');
        }

        // ============================================
        // HISTORY
        // ============================================
        function addToHistoryPanel(question) {
            state.history.unshift({ question, timestamp: Date.now() });
            state.history = state.history.slice(0, 50);
            renderHistoryPanel();
        }

        function renderHistoryPanel() {
            const container = document.getElementById('history-content');
            if (state.history.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted); text-align: center;">Your conversation history will appear here</p>';
                return;
            }
            container.innerHTML = state.history.map(h => `
                <div class="history-item" onclick="askTopic('${h.question.replace(/'/g, "\\'")}')">
                    <div class="history-question">${h.question}</div>
                    <div class="history-meta">${formatTimeAgo(h.timestamp)}</div>
                </div>
            `).join('');
        }

        // ============================================
        // STATS & PROGRESS (Option C)
        // ============================================
        function updateStatsDisplay() {
            document.getElementById('stat-questions').textContent = state.stats.questions;
            document.getElementById('stat-quiz').textContent = state.stats.quizTotal > 0
                ? Math.round((state.stats.quizCorrect / state.stats.quizTotal) * 100) + '%' : '0%';
            document.getElementById('stat-level').textContent = state.stats.level;

            // Update chapters stat
            const module = MODULES[state.currentModule];
            const visited = state.visitedChapters[state.currentModule]?.length || 0;
            const total = module.outline.length;
            document.getElementById('stat-chapters').textContent = `${visited}/${total}`;
        }

        function updateProgress() {
            const module = MODULES[state.currentModule];
            const visited = state.visitedChapters[state.currentModule]?.length || 0;
            const pct = Math.round((visited / module.outline.length) * 100);
            document.getElementById('progress-percent').textContent = pct + '%';
            document.getElementById('progress-fill').style.width = pct + '%';
        }

        function checkLevelUp() {
            const newLevel = Math.floor(state.stats.questions / 5) + 1;
            if (newLevel > state.stats.level) {
                state.stats.level = newLevel;
                const t = translations[state.currentLang];
                showToast(t.levelUp.replace('{level}', newLevel), 'success');
            }
        }

        // ============================================
        // SETTINGS
        // ============================================
        function saveApiKey() {
            state.apiKey = document.getElementById('api-key-input').value.trim();
            localStorage.setItem('prometheus_api_key', state.apiKey);
            showToast(state.currentLang === 'ar' ? 'ØªÙ… Ø­ÙØ¸ Ù…ÙØªØ§Ø­ API!' : 'API key saved!', 'success');
        }

        // ============================================
        // UTILITIES
        // ============================================
        function handleKeyDown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        function copyText(text) {
            navigator.clipboard.writeText(text.replace(/<[^>]*>/g, '').replace(/\*\*/g, ''));
            showToast(state.currentLang === 'ar' ? 'ØªÙ… Ø§Ù„Ù†Ø³Ø®!' : 'Copied!', 'success');
        }

        function toggleLike(btn) {
            btn.classList.toggle('liked');
            showToast(btn.classList.contains('liked') ?
                (state.currentLang === 'ar' ? 'ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ¯ ÙƒÙ…ÙÙŠØ¯!' : 'Marked helpful!') :
                (state.currentLang === 'ar' ? 'ØªÙ…Øª Ø§Ù„Ø¥Ø²Ø§Ù„Ø©' : 'Removed'), 'success');
        }

        function showToast(msg, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<span class="toast-icon">${type === 'success' ? 'âœ“' : 'âœ—'}</span><span class="toast-message">${msg}</span>`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function formatTimeAgo(ts) {
            const s = Math.floor((Date.now() - ts) / 1000);
            if (s < 60) return state.currentLang === 'ar' ? 'Ø§Ù„Ø¢Ù†' : 'Just now';
            if (s < 3600) return Math.floor(s / 60) + (state.currentLang === 'ar' ? ' Ø¯Ù‚ÙŠÙ‚Ø©' : ' min ago');
            if (s < 86400) return Math.floor(s / 3600) + (state.currentLang === 'ar' ? ' Ø³Ø§Ø¹Ø©' : ' hours ago');
            return new Date(ts).toLocaleDateString();
        }
    </script>
</body>
</html>
